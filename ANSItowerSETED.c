#include <stdint.h>
#include <stdio.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>
#include <cpu_speed.h>
#include <macros.h>
#include <sprite.h>
#include <graphics.h>
#include <lcd.h>
#include <stdbool.h>
#include "lcd_model.h"

//Global
int x;
int y;
double dx;
double dy;
double z;

bool start = true;
//Countdown initation
void countdown ( void ){
	clear_screen();
	draw_string(0, 40, "...3", FG_COLOUR);
	show_screen();
	_delay_ms(300);
	clear_screen();
	draw_string(0, 40, "...2", FG_COLOUR);
	show_screen();
	_delay_ms(300);
	clear_screen();
	draw_string(0, 40, "...1", FG_COLOUR);
	show_screen();
	_delay_ms(300);
	clear_screen(); 
}

//Tower
#define tower_w 88
#define tower_h 50
uint8_t towerImage[] = {
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11000011, 0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000011, 0b00000000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000110, 0b00000000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000001,
	0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00001100, 0b00000000, 0b00110000, 0b00000000, 0b00000000, 0b00000000, 0b00000011,
	0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00001000, 0b00000000, 0b00010000, 0b00000000, 0b00000000, 0b00000000, 0b00000110,
	0b00110000, 0b00000000, 0b00000000, 0b00000000, 0b00001000, 0b00000001, 0b10010000, 0b00000000, 0b00000000, 0b00000000, 0b00001100,
	0b00011100, 0b00000000, 0b00000000, 0b00000000, 0b00001000, 0b00000001, 0b10010000, 0b00000000, 0b00000000, 0b00000000, 0b00111000,
	0b00000111, 0b00000000, 0b00000000, 0b00000000, 0b00001000, 0b00000000, 0b00010000, 0b00000000, 0b00000000, 0b00000000, 0b11100000,
	0b00000001, 0b11100000, 0b00000000, 0b00000000, 0b00001000, 0b00000000, 0b00010000, 0b00000000, 0b00000000, 0b00000111, 0b10000000,
	0b00000000, 0b00111100, 0b00000000, 0b00000000, 0b00001000, 0b00000000, 0b00010000, 0b00000000, 0b00000000, 0b00111100, 0b00000000,
	0b00000000, 0b00000111, 0b11100000, 0b00000000, 0b00001000, 0b00000000, 0b00010000, 0b00000000, 0b00000111, 0b11100000, 0b00000000,
	0b00000000, 0b00000000, 0b01111110, 0b00000000, 0b00001000, 0b00000000, 0b00010000, 0b00000000, 0b01111110, 0b00000000, 0b00000000,
	0b00000000, 0b00000000, 0b00000111, 0b11111000, 0b00001000, 0b00000000, 0b00010000, 0b00001111, 0b11100000, 0b00000000, 0b00000000,
	0b00000000, 0b00000000, 0b00000000, 0b00001111, 0b11111000, 0b00000000, 0b00011111, 0b11110000, 0b00000000, 0b00000000, 0b00000000,
};
Sprite tower;
void setup_tower( void ){
	x = (LCD_X / 2);
	y = -5;
	sprite_init(&tower, x, y, tower_w, tower_h, towerImage);
}

//Protagonist 
#define protag_w 8
#define protag_h 11
uint8_t protagImage[] = {
	0b00101000,
	0b00111000,
	0b00101000,
	0b00111000,
	0b00000000,
	0b11111110,
	0b10101010,
	0b10111010,
	0b00101000,
	0b00101000,
	0b00101000,
};
Sprite protag;
void setup_protag( void ){
	x = (LCD_X / 2) - (protag_w / 2);
	y = 30;
	sprite_init(&protag, x, y, protag_w, protag_h, protagImage);
}

//Monster
#define monster_w 8
#define monster_h 7
uint8_t monsterImage[] = {
	0b00111000,
	0b01111100,
	0b01010100,
	0b01111100,
	0b01111100,
	0b01010100,
	0b01010100,
};
Sprite monster;
void setup_monster( void ){
	x = (LCD_X - monster_w);
	y = 28;
	sprite_init(&monster, x, y, monster_w, monster_h, monsterImage);
}

//Key
#define key_w 8
#define key_h 3
uint8_t keyImage[] = {
	0b11100000,
	0b10111110,
	0b11101010,
};
Sprite key;
void setup_key( void ){
	x = (LCD_X - 8) - 76;
	y = 29;
	sprite_init(&key, x, y, key_w, key_h, keyImage);
}

//Player Movement
/*void movement( void ){
	dx = 
	dy = 
}*/


/*	if (BIT_IS_SET(PINF, 5)|| BIT_IS_SET(PINF, 6)){
		countdown();
		sprite_draw(&protag);
		sprite_draw(&monster);
		sprite_draw(&key);
		sprite_draw(&tower);
		show_screen();
	}
*/

//Main game setup and process	
void setup( void ) {
	set_clock_speed(CPU_8MHz);
	lcd_init(LCD_DEFAULT_CONTRAST);
	CLEAR_BIT(DDRF, 6); //left button
	CLEAR_BIT(DDRF, 5); //right button
	CLEAR_BIT(DDRB, 1); //left joystick
	CLEAR_BIT(DDRD, 0); //right joystick
	CLEAR_BIT(DDRD, 1); //up joystick
	CLEAR_BIT(DDRB, 7); //down joystic
	draw_string(20, 0, "ANSI Tower", FG_COLOUR);
	draw_string(25, 8, "Jai Hunt", FG_COLOUR);
	draw_string(25, 16, "10006869", FG_COLOUR);
	draw_string(0, 40, "Press SW2", FG_COLOUR);
	show_screen();	
	setup_protag();
	setup_monster();
	setup_key();
	setup_tower();
}

void process ( void ){
	while (start == true){
		if (BIT_IS_SET(PINF, 5)|| BIT_IS_SET(PINF, 6)){
		countdown();
		sprite_draw(&protag);
		sprite_draw(&monster);
		sprite_draw(&key);
		sprite_draw(&tower);
		show_screen();
		start = false;
		}
	}
}


int main( void ) {
		setup();

	for ( ;; ) {
		process();
		_delay_ms(10);
	}

	return 0;
}